<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rotor — Core Log</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f151d;--text:#eaf1fb;--muted:#9aa7b8;--border:#1b2532;
    --ok:#22c55e;--err:#ef4444;--inf:#7aa2f7;--r:12px;--shadow:0 4px 12px rgba(0,0,0,0.2)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;padding:16px}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:12px;box-shadow:var(--shadow);transition:transform 0.2s}
  .card:hover{transform:translateY(-2px)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#0d131a}
  .btn{appearance:none;border:1px solid var(--border);background:#0d131a;color:var(--text);padding:6px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:background 0.2s}
  .btn:hover{background:#1b2532}
  input[type="text"]{border:1px solid var(--border);background:#0d141b;color:var(--text);padding:6px 10px;border-radius:10px;outline:none;font-size:12px}
  input[type="checkbox"]{transform:translateY(1px);cursor:pointer}
  pre.log{margin:0;border:1px solid var(--border);border-radius:10px;background:#0a1016;height:350px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word;padding:10px}
  .l.ok{color:var(--ok)} .l.err{color:var(--err)} .l.inf{color:var(--inf)}
  .list{display:flex;flex-direction:column;gap:8px;margin:8px 0}
  .item{display:flex;justify-content:space-between;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0c1219}
  .lhs{display:flex;gap:8px;align-items:center}
  .tag{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
  .tag.ok{color:var(--ok);border-color:var(--ok)} .tag.err{color:var(--err);border-color:var(--err)} .tag.inf{color:var(--inf)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="row">
      <label class="pill"><input id="fInfo" type="checkbox" checked> Info</label>
      <label class="pill"><input id="fErr" type="checkbox" checked> Error</label>
      <label class="pill"><input id="fOk" type="checkbox" checked> Berhasil</label>
      <button id="startFollow" class="btn">Start</button>
      <button id="stopFollow" class="btn">Stop</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>
    <div id="groupList" class="list"></div>
    <div class="row" style="margin-bottom:8px">
      <span class="pill">Sumber: <input id="logUrl" type="text" value="/cgi-bin/hgled-log.sh" size="24"></span>
      <label class="pill"><input id="autoscroll" type="checkbox" checked> Auto-scroll</label>
      <span class="pill">Update: <span id="lastUp" class="mono">—</span></span>
    </div>
    <pre id="log" class="log"></pre>
  </section>
</div>
<script>
(() => {
  const $ = s => document.querySelector(s);
  const logEl = $('#log'), fInfo = $('#fInfo'), fErr = $('#fErr'), fOk = $('#fOk');
  const lastUp = $('#lastUp'), urlInput = $('#logUrl'), autoScroll = $('#autoscroll');
  const clearBtn = $('#clearBtn'), startBtn = $('#startFollow'), stopBtn = $('#stopFollow');
  const groupList = $('#groupList');

  let cacheText = ''; let lastLines = [];
  let lastLogTime = null; let logTimer = null;
  let stats = {lastStatus: {}, lastSeen: {}};

  // --- utils
  const esc = s => String(s).replace(/[&<>"]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  const levelOf = line => {
    const s = line.toLowerCase();
    if (s.includes('fail:') || s.includes('error') || s.includes('gagal') || s.includes('alert')) return 'err';
    if (s.includes('ok:') || s.includes('berhasil') || s.includes('sukses')) return 'ok';
    return 'inf';
  };
  const groupFrom = line => {
    const m = line.match(/\b(?:OK|FAIL):\s*([A-Z0-9_-]+)/);
    return m ? m[1] : null;
  };
  const tsOf = line => {
    let m = line.match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
    if (m) return new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:${m[6]}`);
    m = line.match(/^[A-Z][a-z]{2}\s+([A-Z][a-z]{2})\s+(\d{1,2})\s+(\d{2}:\d{2}:\d{2})\s+(\d{4})/);
    if (m) {
      const idx = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}[m[1]] ?? 0;
      const d = parseInt(m[2],10), t = m[3].split(':').map(Number), y = parseInt(m[4],10);
      return new Date(y, idx, d, t[0], t[1], t[2]);
    }
    return null;
  };

  function parseLog(text) {
    try {
      const json = JSON.parse(text);
      lastLines = json.log || [];
    } catch (e) {
      lastLines = [text];
    }
    lastLogTime = null;
    stats = {lastStatus: {}, lastSeen: {}};
    for (const ln of lastLines) {
      const t = tsOf(ln);
      if (t && (!lastLogTime || t.getTime() > lastLogTime.getTime())) lastLogTime = t;
      const g = groupFrom(ln);
      if (g && t) {
        stats.lastSeen[g] = t.getTime();
        const lvl = levelOf(ln);
        if (lvl === 'ok') stats.lastStatus[g] = 'OK';
        else if (lvl === 'err') stats.lastStatus[g] = 'FAIL';
      }
    }
  }

  function renderLog() {
    const out = lastLines
      .filter(ln => (levelOf(ln) === 'inf' && fInfo.checked) || (levelOf(ln) === 'err' && fErr.checked) || (levelOf(ln) === 'ok' && fOk.checked))
      .map(ln => `<span class="l ${levelOf(ln)}">${esc(ln)}</span>`);
    logEl.innerHTML = out.join('\n');
    if (autoScroll.checked) logEl.scrollTop = logEl.scrollHeight;
  }

  function renderGroups() {
    const groups = [...new Set(Object.keys(stats.lastStatus))].sort();
    const html = groups.length ? groups.map(g => {
      const st = stats.lastStatus[g] || '—';
      const tagCls = st === 'OK' ? 'ok' : (st === 'FAIL' ? 'err' : 'inf');
      const last = stats.lastSeen[g] ? new Date(stats.lastSeen[g]).toLocaleTimeString('id-ID') : '—';
      return `<div class="item"><div class="lhs"><span class="tag ${tagCls}">${esc(g)}</span><span class="pill">Status: <span class="mono">${st}</span></span></div><span class="pill">Update: <span class="mono">${last}</span></span></div>`;
    }).join('') : '<div class="item"><span class="pill">Tidak ada grup di log</span></div>';
    groupList.innerHTML = html;
  }

  async function fetchLogOnce() {
    try {
      const url = (urlInput.value || '/cgi-bin/hgled-log.sh') + '?t=' + Date.now();
      const res = await fetch(url, {cache: 'no-store'});
      const txt = await res.text();
      if (txt !== cacheText) {
        cacheText = txt;
        parseLog(txt);
        renderLog();
        renderGroups();
        lastUp.textContent = lastLogTime ? lastLogTime.toLocaleTimeString('id-ID') : '—';
        if (lastLogTime) {
          const now = new Date();
          const diff = now.getTime() - lastLogTime.getTime();
          const nextRefresh = Math.max(500, Math.min(diff * 1.5, 5000)); // Antara 0.5s dan 5s
          if (logTimer) clearInterval(logTimer);
          logTimer = setInterval(fetchLogOnce, nextRefresh);
        }
      }
    } catch (e) {
      logEl.innerHTML = `<span class="l err">Gagal memuat log ${esc(urlInput.value)} — ${esc(e.message || e)}</span>`;
    }
  }

  // persist
  function save() {
    localStorage.setItem('rotor_ui', JSON.stringify({logUrl: urlInput.value}));
  }
  function load() {
    try {
      const s = JSON.parse(localStorage.getItem('rotor_ui') || '{}');
      if (s.logUrl) urlInput.value = s.logUrl;
    } catch {}
  }

  // events
  [fInfo, fErr, fOk].forEach(cb => cb.addEventListener('change', () => { renderLog(); renderGroups(); }));
  clearBtn.addEventListener('click', () => { cacheText = ''; lastLines = []; lastLogTime = null; stats = {lastStatus: {}, lastSeen: {}}; renderLog(); renderGroups(); lastUp.textContent = '—'; });
  urlInput.addEventListener('change', save);
  startBtn.addEventListener('click', () => { if (!logTimer) { fetchLogOnce(); logTimer = setInterval(fetchLogOnce, 500); } });
  stopBtn.addEventListener('click', () => { if (logTimer) { clearInterval(logTimer); logTimer = null; } });

  // init
  load();
  fetchLogOnce();
  logTimer = setInterval(fetchLogOnce, 500);
})();
</script>
</body>
</html>
